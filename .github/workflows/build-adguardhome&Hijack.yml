name: Build AdGuardHome PBR for RouterOS
on:
  workflow_dispatch:
  schedule:
    - cron: '0 4 * * *'

permissions:
  contents: write

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      ah_ver: ${{ steps.get_versions.outputs.ah_ver }}
    steps:
      - name: Get Upstream Version
        id: get_versions
        run: |
          AH_VER=$(curl -s https://api.github.com/repos/AdguardTeam/AdGuardHome/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
          echo "ah_ver=$AH_VER" >> $GITHUB_OUTPUT

  build-and-release:
    needs: check-version
    name: Build ${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: amd64
            ah_arch: amd64
          - arch: arm64
            ah_arch: arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Download AdGuardHome Binary
        run: |
          AH_VER="${{ needs.check-version.outputs.ah_ver }}"
          wget -q "https://github.com/AdguardTeam/AdGuardHome/releases/download/${AH_VER}/AdGuardHome_linux_${{ matrix.ah_arch }}.tar.gz"
          tar -zxf "AdGuardHome_linux_${{ matrix.ah_arch }}.tar.gz"
          mv AdGuardHome/AdGuardHome ./ah-bin
          chmod +x ./ah-bin

      - name: Prepare Docker Build Files
        run: |
          cat <<'EOF' > entrypoint_pbr.sh
          #!/bin/sh
          if [ "$ENABLE_PBR" = "true" ]; then
              echo ">>> [Init] PBR Mode Enabled. Injecting rules..."
              
              # 1. è‡ªåŠ¨å¯»æ‰¾ç½‘å¡ï¼ˆæ’é™¤ lo å›ç¯ï¼‰ï¼Œç²¾å‡†é€‚é… ROS 7 çš„ veth æ˜ å°„æœºåˆ¶
              LAN_IF=$(ls /sys/class/net | grep -v lo | head -n 1)
              echo ">>> [Init] Auto-detected Interface: $LAN_IF"

              # å†…éƒ¨ç­–ç•¥å¸¸é‡ï¼ˆè¿™ä¸‰ä¸ªå‚æ•°å±äºåº•å±‚æœºåˆ¶ï¼Œä¸éœ€è¦ä½ é€šè¿‡å˜é‡æ¥é…ï¼‰
              RT_TABLE=100
              MARK_DEC=53
              RULE_PREF=10000

              # 2. ä¿®å¤ BUG: å½»åº•æ¸…ç©º OUTPUT é“¾ä¸Šçš„æ—§ mangle è§„åˆ™ï¼Œé˜²æ­¢é‡å¯å åŠ 
              iptables -t mangle -F OUTPUT 2>/dev/null || true

              # 3. åŠ¨æ€éå†ä½ é…ç½®çš„ LAN_NET å˜é‡ä¸‹å‘è·¯ç”±å’Œæ‰“æ ‡
              for net in $(env | grep '^LAN_NET' | cut -d= -f2); do
                  echo ">>> [PBR] Applying routes and mangle for subnet: $net"
                  ip route replace "$net" via "$GW_IP" dev "$LAN_IF" table "$RT_TABLE" 2>/dev/null
                  
                  for proto in udp tcp; do
                      iptables -t mangle -A OUTPUT -s "${SRC_IP}/32" -d "$net" -p "$proto" --sport 53 -j MARK --set-mark "$MARK_DEC"
                  done
              done

              # 4. æŒ‚è½½æ€»è·¯ç”±è§„åˆ™è¡¨
              if ! ip rule show | grep -q "pref ${RULE_PREF}.*fwmark $(printf '0x%x' $MARK_DEC).*lookup ${RT_TABLE}"; then
                  ip rule add pref "$RULE_PREF" fwmark "$MARK_DEC" lookup "$RT_TABLE" 2>/dev/null
              fi
              ip route flush cache 2>/dev/null
              echo ">>> [Init] PBR Applied Successfully on $LAN_IF."
          else
              echo ">>> [Init] Standard AdGuardHome Mode."
          fi

          exec /opt/adguardhome/AdGuardHome -h 0.0.0.0 -c /opt/adguardhome/conf/AdGuardHome.yaml -w /opt/adguardhome/work --no-check-update
          EOF
          chmod +x entrypoint_pbr.sh

          cat <<'EOF' > Dockerfile.pbr
          FROM alpine:latest
          RUN apk add --no-cache ca-certificates tzdata iptables iproute2 && \
              cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime && \
              apk del tzdata && \
              mkdir -p /opt/adguardhome/conf /opt/adguardhome/work
          COPY ah-bin /opt/adguardhome/AdGuardHome
          COPY entrypoint_pbr.sh /entrypoint.sh
          EXPOSE 53/tcp 53/udp 80/tcp 443/tcp 3000/tcp
          VOLUME ["/opt/adguardhome/work", "/opt/adguardhome/conf"]
          CMD ["/entrypoint.sh"]
          EOF

      - name: Build and Export ROS-compatible Tar
        run: |
          AH_VER="${{ needs.check-version.outputs.ah_ver }}"
          docker buildx build --platform linux/${{ matrix.arch }} -t ah-pbr:latest --load -f Dockerfile.pbr .
          docker save -o adguardhome-pbr-ros-${AH_VER}-${{ matrix.arch }}.tar ah-pbr:latest

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.check-version.outputs.ah_ver }}
          name: AdGuardHome PBR ${{ needs.check-version.outputs.ah_ver }}
          make_latest: true
          allow_updates: true
          body: |
             ## ğŸ“¦ AdGuardHome for RouterOS (PBR Edition)
             - **AdGuardHome Version**: ${{ needs.check-version.outputs.ah_ver }}
             
             ### ğŸ› ï¸ ç‰¹æ€§æ›´æ–°
             1. **ROS å…¼å®¹å¯¼å…¥**: æ”¯æŒ `.tar` åŸç”Ÿå¯¼å…¥ã€‚
             2. **ç½‘å¡è‡ªå¯»å€**: è‡ªåŠ¨è¯†åˆ« RouterOS ä¼ å…¥çš„ `veth-xxx` æ¥å£ï¼Œå†ä¹Ÿæ— éœ€æ‰‹åŠ¨æŒ‡å®šç½‘å¡ã€‚
             3. **çº¯å‡€å˜é‡**: æ— é»˜è®¤å…œåº•ï¼Œé…ç½®å®Œå…¨ç”±ä½¿ç”¨è€…ç²¾ç¡®æ§åˆ¶ã€‚
             4. **å»é‡æœºåˆ¶**: ä¿®å¤äº†å®¹å™¨è½¯é‡å¯å¯¼è‡´çš„ iptables è§„åˆ™å åŠ  BUGã€‚
          files: |
            adguardhome-pbr-ros-${{ needs.check-version.outputs.ah_ver }}-${{ matrix.arch }}.tar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

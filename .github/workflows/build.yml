name: Auto Build Caddy

# è§¦å‘æœºåˆ¶ï¼šæ¯å¤©è‡ªåŠ¨æ£€æŸ¥ + æ‰‹åŠ¨è§¦å‘
on:
  schedule:
    - cron: '0 4 * * *' # æ¯å¤©å‡Œæ™¨ 4 ç‚¹è‡ªåŠ¨æ£€æŸ¥ä¸€æ¬¡
  workflow_dispatch:    # å…è®¸æ‰‹åŠ¨ç‚¹æŒ‰é’®è§¦å‘

jobs:
  # ä»»åŠ¡ 1: ä¾¦å¯Ÿå…µ â€”â€” æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
  check-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      skip: ${{ steps.check_release.outputs.skip }}
    steps:
      # 1. è·å– Caddy å®˜æ–¹æœ€æ–°ç‰ˆæœ¬å·
      - name: Get Upstream Caddy Version
        id: get_version
        run: |
          # è¯·æ±‚ GitHub API è·å– caddyserver/caddy çš„æœ€æ–° release
          VERSION=$(curl -s https://api.github.com/repos/caddyserver/caddy/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
          echo "ğŸ” Official Caddy Version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # 2. æ£€æŸ¥æˆ‘ä»¬è‡ªå·±çš„ä»“åº“æ˜¯å¦å·²ç»å‘è¿‡è¿™ä¸ªç‰ˆæœ¬
      - name: Check Local Release
        id: check_release
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          # æ£€æŸ¥å½“å‰ä»“åº“ release æ˜¯å¦å­˜åœ¨
          HTTP_CODE=$(curl -o /dev/null -s -w "%{http_code}" https://api.github.com/repos/${{ github.repository }}/releases/tags/$VERSION)
          
          if [ "$HTTP_CODE" -eq "200" ]; then
            echo "âœ… Release $VERSION already exists. Skipping build."
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "ğŸš€ New version $VERSION detected! Starting build..."
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

  # ä»»åŠ¡ 2: å·¥å…µ â€”â€” æ‰§è¡Œæ„å»º (åªæœ‰å½“ skip != true æ—¶æ‰è¿è¡Œ)
  build-and-release:
    needs: check-version
    if: needs.check-version.outputs.skip != 'true'
    name: Build ${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: amd64
            goarch: amd64
          - arch: arm64
            goarch: arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install xcaddy
        run: go install github.com/caddyserver/xcaddy/cmd/xcaddy@latest

      # 1. ç¼–è¯‘ (æŒ‡å®š check-version è·å–åˆ°çš„ç‰ˆæœ¬å·)
      - name: Build Caddy Binary
        run: |
          VERSION="${{ needs.check-version.outputs.version }}"
          echo "Building Caddy $VERSION for ${{ matrix.arch }}..."
          
          GOOS=linux GOARCH=${{ matrix.goarch }} xcaddy build $VERSION \
            --with github.com/caddy-dns/cloudflare \
            --with github.com/mholt/caddy-dynamicdns \
            --output caddy

      # 2. UPX å‹ç¼©
      - name: Install and Run UPX
        run: |
          wget https://github.com/upx/upx/releases/download/v4.2.2/upx-4.2.2-amd64_linux.tar.xz
          tar -xf upx-4.2.2-amd64_linux.tar.xz
          mv upx-4.2.2-amd64_linux/upx /usr/local/bin/upx
          chmod +x caddy
          upx --best --lzma caddy

      # 3. å‡†å¤‡æ–‡ä»¶
      - name: Prepare Binary Asset
        run: |
          cp caddy caddy-linux-${{ matrix.arch }}

      # 4. æ„å»º Docker é•œåƒ
      - name: Build Docker Image
        run: |
          docker build --platform linux/${{ matrix.arch }} -t ros-caddy:${{ matrix.arch }} .

      # 5. å¯¼å‡º Docker é•œåƒ
      - name: Export Docker Image to Tar
        run: |
          docker save -o caddy-docker-${{ matrix.arch }}.tar ros-caddy:${{ matrix.arch }}

      # 6. å‘å¸ƒ Release (å…¨è‡ªåŠ¨æ‰“æ ‡ç­¾)
      - name: Create Release and Upload
        uses: soft

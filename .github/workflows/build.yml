name: Caddy Build (ROS & Linux)

# è§¦å‘è§„åˆ™ï¼šæ‰‹åŠ¨å¼ºåˆ¶ + è‡ªåŠ¨å·¡é€»
on:
  workflow_dispatch:
  schedule:
    - cron: '0 4 * * *' # æ¯å¤© UTC 4:00 (åŒ—äº¬æ—¶é—´ 12:00)

jobs:
  # ç¬¬ä¸€æ­¥ï¼šä¾¦å¯Ÿå…µ - ç¡®å®šç‰ˆæœ¬å·
  check-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      do_build: ${{ steps.decision.outputs.do_build }}
    steps:
      - name: Get Upstream Version
        id: get_version
        run: |
          # æŠ“å–å®˜æ–¹æœ€æ–° Tag (ä¾‹å¦‚ v2.9.1)
          VERSION=$(curl -s https://api.github.com/repos/caddyserver/caddy/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
          echo "ğŸ” Upstream Version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Decide Build
        id: decision
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          IS_MANUAL="${{ github.event_name == 'workflow_dispatch' }}"
          HTTP_CODE=$(curl -o /dev/null -s -w "%{http_code}" https://api.github.com/repos/${{ github.repository }}/releases/tags/$VERSION)
          
          if [ "$IS_MANUAL" == "true" ]; then
            echo "âœ… Manual trigger. Forcing build for $VERSION."
            echo "do_build=true" >> $GITHUB_OUTPUT
          elif [ "$HTTP_CODE" -ne "200" ]; then
            echo "ğŸš€ New version $VERSION detected. Building."
            echo "do_build=true" >> $GITHUB_OUTPUT
          else
            echo "ğŸ’¤ Version $VERSION already exists. Skipping."
            echo "do_build=false" >> $GITHUB_OUTPUT
          fi

  # ç¬¬äºŒæ­¥ï¼šå·¥å…µ - æ„å»ºå¹¶åˆ†æµå¯¼å‡º
  build-and-release:
    needs: check-version
    if: needs.check-version.outputs.do_build == 'true'
    name: Build ${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: amd64
            goarch: amd64
          - arch: arm64
            goarch: arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: image=moby/buildkit:latest

      - name: Install xcaddy
        run: go install github.com/caddyserver/xcaddy/cmd/xcaddy@latest

      # 1. æ ¸å¿ƒç¼–è¯‘ (ä¸€æ¬¡ç¼–è¯‘ï¼Œå¤„å¤„ä½¿ç”¨)
      - name: Build & Compress Binary
        run: |
          VERSION="${{ needs.check-version.outputs.version }}"
          echo "Building Caddy $VERSION..."
          
          GOOS=linux GOARCH=${{ matrix.goarch }} xcaddy build $VERSION \
            --with github.com/caddy-dns/cloudflare \
            --with github.com/mholt/caddy-dynamicdns \
            --output caddy
          
          # UPX å‹ç¼©
          wget https://github.com/upx/upx/releases/download/v4.2.2/upx-4.2.2-amd64_linux.tar.xz
          tar -xf upx-4.2.2-amd64_linux.tar.xz
          mv upx-4.2.2-amd64_linux/upx /usr/local/bin/upx
          chmod +x caddy
          upx --best --lzma caddy

      # 2. å‡†å¤‡äº§ç‰© Aï¼šé€šç”¨ Linux äºŒè¿›åˆ¶ (æ”¹ååŒºåˆ†)
      - name: Prepare Universal Binary
        run: |
          # å‘½åæ ¼å¼: caddy-linux-v2.x.x-amd64
          cp caddy caddy-linux-${{ needs.check-version.outputs.version }}-${{ matrix.arch }}

      # 3. å‡†å¤‡äº§ç‰© Bï¼šé€šç”¨ Linux Docker é•œåƒ (æ ‡å‡†æ„å»º)
      - name: Build Universal Docker
        run: |
          VERSION="${{ needs.check-version.outputs.version }}"
          docker build --platform linux/${{ matrix.arch }} -t caddy-universal:$VERSION .
          # å¯¼å‡ºæ–‡ä»¶å: caddy-linux-docker-v2.x.x-amd64.tar
          docker save -o caddy-linux-docker-${VERSION}-${{ matrix.arch }}.tar caddy-universal:$VERSION

      # 4. å‡†å¤‡äº§ç‰© Cï¼šRouterOS ä¸“ç”¨é•œåƒ (ç‰¹æ®Šå…¼å®¹æ„å»º)
      - name: Build RouterOS Docker
        run: |
          VERSION="${{ needs.check-version.outputs.version }}"
          # å…³é”®å‚æ•°: --provenance=false (ROS å…¼å®¹æ ¸å¿ƒ)
          docker build --platform linux/${{ matrix.arch }} --provenance=false -t caddy-ros:$VERSION .
          # å¯¼å‡ºæ–‡ä»¶å: caddy-ros-docker-v2.x.x-amd64.tar
          docker save -o caddy-ros-docker-${VERSION}-${{ matrix.arch }}.tar caddy-ros:$VERSION

      # 5. ç»Ÿä¸€å‘å¸ƒ
      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.check-version.outputs.version }}
          name: Caddy ${{ needs.check-version.outputs.version }} (All Platforms)
          body: |
             ## ğŸš€ Auto Build ${{ needs.check-version.outputs.version }}
             Includes Plugins: `cloudflare`, `caddy-dynamicdns`
             
             ### ğŸ“‚ File Guide (æ–‡ä»¶è¯´æ˜):
             
             #### 1. RouterOS ä¸“ç”¨ (ROS Only)
             *å…¼å®¹æ€§ä¼˜åŒ–ï¼Œä¸å«äºŒè¿›åˆ¶ï¼Œä»…é•œåƒ*
             - `caddy-ros-docker-...-arm64.tar`: é€‚ç”¨äº N1/æ ‘è“æ´¾/ç¡¬è·¯ç”± ROS
             - `caddy-ros-docker-...-amd64.tar`: é€‚ç”¨äº CHR/PVE/ESXi è™šæ‹Ÿæœº ROS
             
             #### 2. é€šç”¨ Linux (Universal Linux)
             *æ ‡å‡† Docker é•œåƒ + ç‹¬ç«‹äºŒè¿›åˆ¶æ–‡ä»¶*
             - `caddy-linux-docker-...tar`: æ ‡å‡† Docker å¯¼å…¥åŒ…
             - `caddy-linux-...`: ç‹¬ç«‹å¯æ‰§è¡Œæ–‡ä»¶ (Alpine/Ubuntu ç›´æ¥è¿è¡Œ)
          files: |
            caddy-linux-${{ needs.check-version.outputs.version }}-${{ matrix.arch }}
            caddy-linux-docker-${{ needs.check-version.outputs.version }}-${{ matrix.arch }}.tar
            caddy-ros-docker-${{ needs.check-version.outputs.version }}-${{ matrix.arch }}.tar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

name: Caddy&ddnsgo Build
on:
  workflow_dispatch:
  schedule:
    - cron: '0 4 * * *'

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      caddy_ver: ${{ steps.get_versions.outputs.caddy_ver }}
      ddns_ver: ${{ steps.get_versions.outputs.ddns_ver }}
      full_tag: ${{ steps.get_versions.outputs.full_tag }}
      do_build: ${{ steps.decision.outputs.do_build }}
    steps:
      - name: Get Upstream Versions
        id: get_versions
        run: |
          # 1. è·å– Caddy æœ€æ–°ç‰ˆ
          CADDY_VER=$(curl -s https://api.github.com/repos/caddyserver/caddy/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
          
          # 2. è·å– NewFuture/DDNS æœ€æ–°ç‰ˆ
          DDNS_VER=$(curl -s https://api.github.com/repos/NewFuture/DDNS/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
          
          # 3. ç»„åˆå¤åˆ Tag (ä¾‹: v2.7.6_ddns-v2.11.0)
          FULL_TAG="${CADDY_VER}_ddns-${DDNS_VER}"
          
          echo "caddy_ver=$CADDY_VER" >> $GITHUB_OUTPUT
          echo "ddns_ver=$DDNS_VER" >> $GITHUB_OUTPUT
          echo "full_tag=$FULL_TAG" >> $GITHUB_OUTPUT
          echo "Detected: Caddy $CADDY_VER + DDNS $DDNS_VER => $FULL_TAG"

      - name: Decide Build
        id: decision
        run: |
          FULL_TAG="${{ steps.get_versions.outputs.full_tag }}"
          IS_MANUAL="${{ github.event_name == 'workflow_dispatch' }}"
          
          # æ£€æŸ¥è¯¥å¤åˆ Tag æ˜¯å¦å·²å­˜åœ¨äº Release ä¸­
          HTTP_CODE=$(curl -o /dev/null -s -w "%{http_code}" https://api.github.com/repos/${{ github.repository }}/releases/tags/$FULL_TAG)
          
          if [ "$IS_MANUAL" == "true" ]; then
            echo "Manual trigger."
            echo "do_build=true" >> $GITHUB_OUTPUT
          elif [ "$HTTP_CODE" -ne "200" ]; then
            echo "New version combination found ($FULL_TAG)."
            echo "do_build=true" >> $GITHUB_OUTPUT
          else
            echo "Version $FULL_TAG already exists. Skipping."
            echo "do_build=false" >> $GITHUB_OUTPUT
          fi

  build-and-release:
    needs: check-version
    if: needs.check-version.outputs.do_build == 'true'
    name: Build ${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: amd64
            goarch: amd64
          - arch: arm64
            goarch: arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install xcaddy
        run: go install github.com/caddyserver/xcaddy/cmd/xcaddy@latest

      # ----------------------------------------------------------------
      # 1. ç¼–è¯‘ Caddy äºŒè¿›åˆ¶
      # ----------------------------------------------------------------
      - name: Build Caddy Binary
        run: |
          VERSION="${{ needs.check-version.outputs.caddy_ver }}"
          GOOS=linux GOARCH=${{ matrix.goarch }} xcaddy build $VERSION \
            --with github.com/caddy-dns/cloudflare \
            --output caddy
          
          # å‹ç¼©äºŒè¿›åˆ¶
          wget -q https://github.com/upx/upx/releases/download/v4.2.2/upx-4.2.2-amd64_linux.tar.xz
          tar -xf upx-4.2.2-amd64_linux.tar.xz
          mv upx-4.2.2-amd64_linux/upx /usr/local/bin/upx
          chmod +x caddy
          upx --best --lzma caddy

      # ----------------------------------------------------------------
      # 2. å‡†å¤‡ NewFuture/DDNS
      # ----------------------------------------------------------------
      - name: Prepare DDNS Binary
        run: |
          # è‡ªåŠ¨è·å– NewFuture DDNS çš„ musl ç‰ˆæœ¬ (å…¼å®¹ Alpine)
          DDNS_VER="${{ needs.check-version.outputs.ddns_ver }}"
          echo "Downloading DDNS $DDNS_VER..."
          
          # æ³¨æ„ï¼šAPI URL è·å–ç‰¹å®šæ¶æ„çš„ä¸‹è½½é“¾æ¥
          DDNS_URL=$(curl -s https://api.github.com/repos/NewFuture/DDNS/releases/tags/${DDNS_VER} | grep "browser_download_url" | grep "musl-linux_${{ matrix.goarch }}" | head -n 1 | cut -d '"' -f 4)
          
          if [ -z "$DDNS_URL" ]; then
            echo "Error: Could not find DDNS binary for ${{ matrix.goarch }}"
            exit 1
          fi
          
          wget -q -O ddns "$DDNS_URL"
          chmod +x ddns

      # ----------------------------------------------------------------
      # 3. æ„å»ºå¹¶å¯¼å‡º - Caddy + DDNS (ROS å…¼å®¹æ¨¡å¼)
      # âš ï¸ å…³é”®ä¿®æ­£: å…ˆ load åˆ° docker daemonï¼Œå† docker save å¯¼å‡ºçº¯ tar
      # ----------------------------------------------------------------
      - name: Build & Export (Caddy+DDNS for ROS)
        run: |
          FULL_TAG="${{ needs.check-version.outputs.full_tag }}"
          
          # åˆ›å»ºå¯åŠ¨è„šæœ¬
          cat <<EOF > entrypoint_ddns.sh
          #!/bin/sh
          if [ -f /config/config.json ]; then
             echo "Starting NewFuture/DDNS..."
             /usr/bin/ddns -c /config/config.json &
          fi
          exec caddy run --config /etc/caddy/Caddyfile --adapter caddyfile
          EOF
          chmod +x entrypoint_ddns.sh

          # åˆ›å»º Dockerfile
          cat <<EOF > Dockerfile.ros
          FROM alpine:latest
          RUN apk add --no-cache ca-certificates tzdata && \
              cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime && \
              echo "Asia/Shanghai" > /etc/timezone && \
              apk del tzdata && \
              mkdir -p /config /data /etc/caddy
          COPY caddy /usr/bin/caddy
          COPY ddns /usr/bin/ddns
          COPY entrypoint_ddns.sh /entrypoint.sh
          ENV XDG_CONFIG_HOME=/config
          ENV XDG_DATA_HOME=/data
          EXPOSE 80 443 2019
          CMD ["/entrypoint.sh"]
          EOF

          # 1. Load åˆ°æœ¬åœ° Docker Daemon (å¿…é¡»!)
          docker buildx build \
            --platform linux/${{ matrix.arch }} \
            -t caddy-ddns:ros-local \
            -f Dockerfile.ros \
            --load \
            .
            
          # 2. Save å¯¼å‡º (ä¸ä½¿ç”¨ gzipï¼Œç”Ÿæˆçº¯ tarï¼ŒROS å…¼å®¹æ€§æœ€å¥½)
          docker save -o caddy-ddns-ros-${FULL_TAG}-${{ matrix.arch }}.tar caddy-ddns:ros-local

      # ----------------------------------------------------------------
      # 4. æ„å»ºå¹¶å¯¼å‡º - çº¯å‡€ç‰ˆ Caddy (ROS å…¼å®¹æ¨¡å¼)
      # ----------------------------------------------------------------
      - name: Build & Export (Pure Caddy for ROS)
        run: |
          VERSION="${{ needs.check-version.outputs.caddy_ver }}"
          
          # ä½¿ç”¨çº¯å‡€ç‰ˆ Dockerfile (å¤ç”¨ context ä¸­çš„ default)
          docker buildx build \
            --platform linux/${{ matrix.arch }} \
            -t caddy-pure:ros-local \
            --load \
            .
            
          docker save -o caddy-pure-ros-${VERSION}-${{ matrix.arch }}.tar caddy-pure:ros-local

      # ----------------------------------------------------------------
      # 5. ä¸Šä¼  Release
      # ----------------------------------------------------------------
      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.check-version.outputs.full_tag }}
          name: ${{ needs.check-version.outputs.full_tag }}
          body: |
             ## ğŸš€ Auto Build
             - **Caddy**: ${{ needs.check-version.outputs.caddy_ver }}
             - **DDNS**: ${{ needs.check-version.outputs.ddns_ver }} (NewFuture)
             
             ### ğŸ“‚ æ–‡ä»¶è¯´æ˜ (ROS 7.x ä¸“ç”¨)
             æ‰€æœ‰é•œåƒå‡ä¸º **Uncompressed Tar (æ— å‹ç¼©)**ï¼Œä»¥è§£å†³ ROS `no config found` é—®é¢˜ã€‚
             
             - `caddy-ddns-ros-....tar`: **æ¨è**ã€‚åŒ…å« Caddy + NewFuture DDNSã€‚
               - éœ€æŒ‚è½½ `/config/config.json` å¯ç”¨ DDNSã€‚
             - `caddy-pure-ros-....tar`: ä»…åŒ…å« Caddyã€‚
          files: |
            caddy-ddns-ros-${{ needs.check-version.outputs.full_tag }}-${{ matrix.arch }}.tar
            caddy-pure-ros-${{ needs.check-version.outputs.caddy_ver }}-${{ matrix.arch }}.tar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

name: Caddy Build (Caddy & DDNS-GO)
on:
  workflow_dispatch:
  schedule:
    - cron: '0 4 * * *'

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      caddy_ver: ${{ steps.get_versions.outputs.caddy_ver }}
      ddns_ver: ${{ steps.get_versions.outputs.ddns_ver }}
      do_build: ${{ steps.decision.outputs.do_build }}
    steps:
      - name: Get Upstream Versions
        id: get_versions
        run: |
          CADDY_VER=$(curl -s https://api.github.com/repos/caddyserver/caddy/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
          DDNS_VER=$(curl -s https://api.github.com/repos/jeessy2/ddns-go/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
          
          echo "caddy_ver=$CADDY_VER" >> $GITHUB_OUTPUT
          echo "ddns_ver=$DDNS_VER" >> $GITHUB_OUTPUT

      - name: Decide Build
        id: decision
        run: |
          CADDY_VER="${{ steps.get_versions.outputs.caddy_ver }}"
          IS_MANUAL="${{ github.event_name == 'workflow_dispatch' }}"
          HTTP_CODE=$(curl -o /dev/null -s -w "%{http_code}" https://api.github.com/repos/${{ github.repository }}/releases/tags/$CADDY_VER)
          
          if [ "$IS_MANUAL" == "true" ] || [ "$HTTP_CODE" -ne "200" ]; then
            echo "do_build=true" >> $GITHUB_OUTPUT
          else
            echo "do_build=false" >> $GITHUB_OUTPUT
          fi

  build-and-release:
    needs: check-version
    if: needs.check-version.outputs.do_build == 'true'
    name: Build ${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: amd64
            goarch: amd64
          - arch: arm64
            goarch: arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      # ⚠️ 移除 Buildx Setup，使用原生 Docker 以保证 ROS 兼容性 ⚠️
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Install xcaddy
        run: go install github.com/caddyserver/xcaddy/cmd/xcaddy@latest

      # ----------------------------------------------------------------
      # 1. 编译 Caddy 二进制 & 准备 DDNS
      # ----------------------------------------------------------------
      - name: Build Binary & Prep
        run: |
          VERSION="${{ needs.check-version.outputs.caddy_ver }}"
          
          # A. 编译 Caddy
          GOOS=linux GOARCH=${{ matrix.goarch }} xcaddy build $VERSION \
            --with github.com/caddy-dns/cloudflare \
            --output caddy
          
          wget -q https://github.com/upx/upx/releases/download/v4.2.2/upx-4.2.2-amd64_linux.tar.xz
          tar -xf upx-4.2.2-amd64_linux.tar.xz
          mv upx-4.2.2-amd64_linux/upx /usr/local/bin/upx
          chmod +x caddy
          upx --best --lzma caddy
          
          # 备份二进制用于上传 (名称：caddy-linux-vX.X.X-arch)
          cp caddy caddy-linux-${VERSION}-${{ matrix.arch }}

          # B. 下载 DDNS-GO
          DDNS_TAG="${{ needs.check-version.outputs.ddns_ver }}"
          DDNS_NO_V=$(echo "$DDNS_TAG" | sed 's/^v//')
          if [ "${{ matrix.goarch }}" == "amd64" ]; then DDNS_ARCH="x86_64"; else DDNS_ARCH="arm64"; fi
          
          wget -q "https://github.com/jeessy2/ddns-go/releases/download/${DDNS_TAG}/ddns-go_${DDNS_NO_V}_linux_${DDNS_ARCH}.tar.gz"
          tar -zxf "ddns-go_${DDNS_NO_V}_linux_${DDNS_ARCH}.tar.gz"
          mv ddns-go ddns
          chmod +x ddns

      # ----------------------------------------------------------------
      # 2. 构建 Pure Linux Docker (纯净版 - 通用)
      # ----------------------------------------------------------------
      - name: Build Pure Linux Docker
        run: |
          VERSION="${{ needs.check-version.outputs.caddy_ver }}"
          
          cat <<EOF > Dockerfile.pure
          FROM alpine:latest
          RUN apk add --no-cache ca-certificates tzdata && \
              cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime && \
              apk del tzdata && mkdir -p /config /data /etc/caddy
          COPY caddy /usr/bin/caddy
          ENV XDG_CONFIG_HOME=/config XDG_DATA_HOME=/data
          EXPOSE 80 443 2019
          CMD ["caddy", "run", "--config", "/etc/caddy/Caddyfile", "--adapter", "caddyfile"]
          EOF
          
          # 使用原生 docker build 避免 manifests 问题
          docker build --platform linux/${{ matrix.arch }} -t caddy-pure:latest -f Dockerfile.pure .
          docker save -o caddy-linux-docker-${VERSION}-${{ matrix.arch }}.tar caddy-pure:latest

      # ----------------------------------------------------------------
      # 3. 构建 Pure ROS Docker (纯净版 - ROS)
      # 实际上内容同上，仅文件名不同以示区分，为了 ROS 兼容性，步骤保持一致
      # ----------------------------------------------------------------
      - name: Build Pure ROS Docker
        run: |
          VERSION="${{ needs.check-version.outputs.caddy_ver }}"
          cp caddy-linux-docker-${VERSION}-${{ matrix.arch }}.tar caddy-ros-docker-${VERSION}-${{ matrix.arch }}.tar

      # ----------------------------------------------------------------
      # 4. 构建 DDNS ROS Docker (集成版 - 修正配置路径 & 文件名)
      # ----------------------------------------------------------------
      - name: Build DDNS ROS Docker
        run: |
          CADDY_VER="${{ needs.check-version.outputs.caddy_ver }}"
          DDNS_VER="${{ needs.check-version.outputs.ddns_ver }}"
          # 组合版本号用于文件名
          COMBINED_TAG="${CADDY_VER}_ddns-${DDNS_VER}"
          
          # 修正：配置路径改为 /etc/ddns-go/config.yaml
          cat <<EOF > entrypoint_ddns.sh
          #!/bin/sh
          echo ">>> [Init] Waiting for network interface (Max 30s)..."
          TIMEOUT=30
          COUNT=0
          while [ \$COUNT -lt \$TIMEOUT ]; do
             if ip addr show dev eth0 2>/dev/null | grep -q "inet"; then
                echo ">>> [Init] Network Ready!"
                break
             fi
             echo ">>> [Init] Waiting for IP..."
             sleep 1
             COUNT=\$((COUNT+1))
          done
          
          echo ">>> [Step 1] Starting DDNS-GO..."
          # ⚠️ 关键修正: 指定 config.yaml
          /usr/bin/ddns -l :9876 -f 300 -c /etc/ddns-go/config.yaml 2>&1 &
          
          echo ">>> [Step 2] Starting Caddy..."
          exec caddy run --config /etc/caddy/Caddyfile --adapter c

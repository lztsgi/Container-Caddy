name: Caddy Build (Caddy & DDNS-GO)
on:
  workflow_dispatch:
  schedule:
    - cron: '0 4 * * *'

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      caddy_ver: ${{ steps.get_versions.outputs.caddy_ver }}
      ddns_ver: ${{ steps.get_versions.outputs.ddns_ver }}
    steps:
      - name: Get Upstream Versions
        id: get_versions
        run: |
          CADDY_VER=$(curl -s https://api.github.com/repos/caddyserver/caddy/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
          DDNS_VER=$(curl -s https://api.github.com/repos/jeessy2/ddns-go/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
          
          echo "caddy_ver=$CADDY_VER" >> $GITHUB_OUTPUT
          echo "ddns_ver=$DDNS_VER" >> $GITHUB_OUTPUT
          echo ">>> Target: Caddy $CADDY_VER | DDNS $DDNS_VER"

  build-and-release:
    needs: check-version
    name: Build ${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: amd64
            goarch: amd64
          - arch: arm64
            goarch: arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      # âš ï¸ å…³é”®ä¿®æ­£ï¼šå¯ç”¨ Buildx ä»¥æ”¯æŒ --load (è§£å†³ ROS æ ¼å¼ä¸å…¼å®¹é—®é¢˜)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install xcaddy
        run: go install github.com/caddyserver/xcaddy/cmd/xcaddy@latest

      # ----------------------------------------------------------------
      # 1. ç¼–è¯‘ Caddy äºŒè¿›åˆ¶ (ä¿æŒä¸å˜)
      # ----------------------------------------------------------------
      - name: Build Binary & Prep
        run: |
          CADDY_VER="${{ needs.check-version.outputs.caddy_ver }}"
          DDNS_VER="${{ needs.check-version.outputs.ddns_ver }}"
          
          echo ">>> Building Caddy Binary..."
          GOOS=linux GOARCH=${{ matrix.goarch }} xcaddy build $CADDY_VER \
            --with github.com/caddy-dns/cloudflare \
            --output caddy
          
          # å‹ç¼©
          wget -q https://github.com/upx/upx/releases/download/v4.2.2/upx-4.2.2-amd64_linux.tar.xz
          tar -xf upx-4.2.2-amd64_linux.tar.xz
          mv upx-4.2.2-amd64_linux/upx /usr/local/bin/upx
          chmod +x caddy
          upx --best --lzma caddy
          cp caddy caddy-linux-${CADDY_VER}-${{ matrix.arch }}

          # å‡†å¤‡ DDNS-GO
          echo ">>> Downloading DDNS-GO..."
          DDNS_NO_V=$(echo "$DDNS_VER" | sed 's/^v//')
          if [ "${{ matrix.goarch }}" == "amd64" ]; then DDNS_ARCH="x86_64"; else DDNS_ARCH="arm64"; fi
          wget -q "https://github.com/jeessy2/ddns-go/releases/download/${DDNS_VER}/ddns-go_${DDNS_NO_V}_linux_${DDNS_ARCH}.tar.gz"
          tar -zxf "ddns-go_${DDNS_NO_V}_linux_${DDNS_ARCH}.tar.gz"
          mv ddns-go ddns
          chmod +x ddns

      # ----------------------------------------------------------------
      # 2. æ„å»º Pure Universal Docker (é€»è¾‘2ï¼šåˆå¹¶ Linux & ROS)
      # ----------------------------------------------------------------
      - name: Build Pure Universal Docker
        run: |
          CADDY_VER="${{ needs.check-version.outputs.caddy_ver }}"
          
          cat <<EOF > Dockerfile.pure
          FROM alpine:latest
          RUN apk add --no-cache ca-certificates tzdata && \
              cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime && \
              apk del tzdata && mkdir -p /config /data /etc/caddy
          COPY caddy /usr/bin/caddy
          ENV XDG_CONFIG_HOME=/config XDG_DATA_HOME=/data
          EXPOSE 80 443 2019
          CMD ["caddy", "run", "--config", "/etc/caddy/Caddyfile", "--adapter", "caddyfile"]
          EOF
          
          # [Fix] ä½¿ç”¨ buildx --load å¹¶åœ¨å¯¼å‡ºæ—¶ä½¿ç”¨æ ‡å‡† Docker Tag
          # è¿™æ ·ç”Ÿæˆçš„ Tar åŒ…æ—¢èƒ½è¢« Docker loadï¼Œä¹Ÿèƒ½è¢« ROS import
          docker buildx build --platform linux/${{ matrix.arch }} -t caddy-pure:latest --load -f Dockerfile.pure .
          docker save -o caddy-docker-universal-${CADDY_VER}-${{ matrix.arch }}.tar caddy-pure:latest

      # ----------------------------------------------------------------
      # 3. æ„å»º DDNS Universal Docker (é€»è¾‘1ï¼šç¯å¢ƒå˜é‡æ§åˆ¶æ£€æµ‹)
      # ----------------------------------------------------------------
      - name: Build DDNS Universal Docker
        run: |
          CADDY_VER="${{ needs.check-version.outputs.caddy_ver }}"
          DDNS_VER="${{ needs.check-version.outputs.ddns_ver }}"
          COMBINED_TAG="${CADDY_VER}_ddns-${DDNS_VER}"
          
          # âš ï¸ [Fix] å¯åŠ¨è„šæœ¬ï¼šå®ç°ç¯å¢ƒå˜é‡æ£€æµ‹é€»è¾‘ + 10åˆ†é’Ÿç­‰å¾…
          cat <<EOF > entrypoint_ddns.sh
          #!/bin/sh
          
          # è¯»å–ç¯å¢ƒå˜é‡ï¼Œé»˜è®¤ä¸º auto
          MODE=\${CHECK_MODE:-auto}
          echo ">>> [Init] Network Check Mode: \$MODE"

          # è¾…åŠ©å‡½æ•°
          check_ipv6() { ip -6 addr show scope global | grep -q "inet6"; }
          check_ipv4() { ip -4 addr show | grep -q "inet"; }
          check_auto() { ip addr show | grep -q "inet"; }

          # å¾ªç¯ç­‰å¾… (Max 600s)
          MAX=60
          WAIT=10
          COUNT=0
          
          while [ \$COUNT -lt \$MAX ]; do
             READY=0
             if [ "\$MODE" = "ipv6" ]; then
                check_ipv6 && READY=1
             elif [ "\$MODE" = "ipv4" ]; then
                check_ipv4 && READY=1
             else
                check_auto && READY=1
             fi

             if [ \$READY -eq 1 ]; then
                echo ">>> [Init] Network Ready (\$MODE)!"
                if [ "\$MODE" = "ipv6" ]; then ip -6 addr show scope global; fi
                break
             fi
             
             if [ \$((COUNT % 3)) -eq 0 ]; then
                echo ">>> [Init] Waiting for IP... (\$((COUNT * WAIT))s / 600s)"
             fi
             sleep \$WAIT
             COUNT=\$((COUNT+1))
          done

          # å³ä½¿è¶…æ—¶ä¹Ÿå°è¯•å¯åŠ¨ï¼Œé¿å…å½»åº•æ­»é”
          if [ \$COUNT -eq \$MAX ]; then echo ">>> [WARN] Timeout waiting for IP."; fi

          # ç«¯å£æ¸…ç†å°è¯• (é¿å… Address in use)
          if netstat -tulpn 2>/dev/null | grep -q ":80 "; then
             echo ">>> [WARN] Port 80 busy, waiting 5s..."
             sleep 5
          fi

          echo ">>> [Step 1] Starting DDNS-GO..."
          # é”å®šé…ç½®è·¯å¾„
          /usr/bin/ddns -l :9876 -f 300 -c /etc/ddns-go/config.yaml 2>&1 &
          
          echo ">>> [Step 2] Starting Caddy (Delay 2s)..."
          sleep 2
          exec caddy run --config /etc/caddy/Caddyfile --adapter caddyfile
          EOF
          chmod +x entrypoint_ddns.sh

          # å¢åŠ  net-tools æ–¹ä¾¿è°ƒè¯•
          cat <<EOF > Dockerfile.ddns
          FROM alpine:latest
          RUN apk add --no-cache ca-certificates tzdata iproute2 net-tools && \
              cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime && \
              apk del tzdata && mkdir -p /config /data /etc/caddy /etc/ddns-go
          COPY caddy /usr/bin/caddy
          COPY ddns /usr/bin/ddns
          COPY entrypoint_ddns.sh /entrypoint.sh
          ENV XDG_CONFIG_HOME=/config XDG_DATA_HOME=/data
          # é»˜è®¤ç¯å¢ƒå˜é‡
          ENV CHECK_MODE=auto
          EXPOSE 80 443 2019 9876
          CMD ["/entrypoint.sh"]
          EOF

          # æ„å»ºå¹¶å¯¼å‡ºé€šç”¨ç‰ˆ
          docker buildx build --platform linux/${{ matrix.arch }} -t caddy-ddns:latest --load -f Dockerfile.ddns .
          docker save -o caddy-ddns-docker-universal-${COMBINED_TAG}-${{ matrix.arch }}.tar caddy-ddns:latest

      # ----------------------------------------------------------------
      # 4. ä¸Šä¼  (æ–‡ä»¶ç²¾ç®€ä¸º 3 ç±»)
      # ----------------------------------------------------------------
      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.check-version.outputs.caddy_ver }}
          name: Caddy ${{ needs.check-version.outputs.caddy_ver }}
          make_latest: true
          allow_updates: true
          body: |
             ## ğŸ“¦ Build Summary (with Cloudflare Plugin)
             - **Caddy**: ${{ needs.check-version.outputs.caddy_ver }}
             - **DDNS-GO**: ${{ needs.check-version.outputs.ddns_ver }}
             
             ### ğŸ› ï¸ åŠŸèƒ½
             1. **ROS/Linux é€šç”¨åŒ–**: æ‰€æœ‰ `.tar` å‡å¯ç›´æ¥å¯¼å…¥ RouterOS 7.x æˆ– `docker load`ã€‚
             2. **æ™ºèƒ½ç½‘ç»œç­‰å¾…**: DDNS ç‰ˆé•œåƒæ”¯æŒé€šè¿‡ç¯å¢ƒå˜é‡ `CHECK_MODE` æ§åˆ¶å¯åŠ¨ç­‰å¾…é€»è¾‘ã€‚
                - `CHECK_MODE=ipv6` : ç­‰å¾… IPv6 Global åœ°å€ (æ¨è ROS ç”¨æˆ·)
                - `CHECK_MODE=ipv4` : ç­‰å¾… IPv4 åœ°å€
                - `CHECK_MODE=auto` : ä»»æ„ IP å³å¯åŠ¨ (é»˜è®¤)
             
             ### ğŸ“‚ æ–‡ä»¶åˆ—è¡¨
             1. `caddy-linux-v...` : äºŒè¿›åˆ¶æ–‡ä»¶
             2. `caddy-docker-universal-...tar` : Docker (æ—  DDNS)
             3. `caddy-ddns-docker-universal-...tar` : é›†æˆç‰ˆ Docker (å« DDNS + å¯åŠ¨ç­‰å¾…ç½‘å¡è„šæœ¬)
          files: |
            caddy-linux-${{ needs.check-version.outputs.caddy_ver }}-${{ matrix.arch }}
            caddy-docker-universal-${{ needs.check-version.outputs.caddy_ver }}-${{ matrix.arch }}.tar
            caddy-ddns-docker-universal-${{ needs.check-version.outputs.caddy_ver }}_ddns-${{ needs.check-version.outputs.ddns_ver }}-${{ matrix.arch }}.tar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
